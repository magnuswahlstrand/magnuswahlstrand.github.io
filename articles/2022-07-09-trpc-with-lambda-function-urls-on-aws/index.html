<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Even simpler way of calling your AWS backend - wahlstrand.dev</title>
  <meta name="description" content="with tRPC and Lambda function URLS">
  <meta name="author" content="Magnus Wahlstrand"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "wahlstrand.dev",
    
    "url": "https:\/\/magnuswahlstrand.github.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/magnuswahlstrand.github.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/magnuswahlstrand.github.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/magnuswahlstrand.github.io\/articles\/2022-07-09-trpc-with-lambda-function-urls-on-aws\/",
          "name": "Even simpler way of calling your aws backend"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Magnus Wahlstrand"
  },
  "headline": "Even simpler way of calling your AWS backend",
  "description" : "A few weeks I wrote a post about using tRPC to get type safe requests between a web client and the server. It turns out that there is an even simpler way of calling your AWS backend (still using tRPC) ü§Ø!\nIn this post I will show you how to use tRPC and a Lambda function with Lambda Function URLs to create a ToDo-app for my terminal. The backend is deployed to AWS using the Serverless Stack.\n   AsciinemaPlayer.create(\u0022\/casts\/trpc-with-lambda-function-urls-on-aws\/ts-prompt.cast\u0022, document.getElementById(\u0027demo1\u0027), { \u0022autoplay\u0022: \u0022true\u0022,\u0022cols\u0022: \u002280\u0022,\u0022loop\u0022: \u0022true\u0022,\u0022poster\u0022: \u0022npt:0:04\u0022,\u0022rows\u0022: \u002214\u0022, });  To run this asciicast without javascript, use asciinema play https:\/\/magnuswahlstrand.github.io\/casts\/trpc-with-lambda-function-urls-on-aws\/ts-prompt.cast with Asciinema\n",
  "inLanguage" : "en",
  "wordCount":  2271 ,
  "datePublished" : "2022-07-09T00:00:00",
  "dateModified" : "2022-07-09T00:00:00",
  "image" : "https:\/\/magnuswahlstrand.github.io\/img\/avatar-icon.png",
  "keywords" : [ "aws, lambda, serverless, sst, trpc, typescript" ],
  "mainEntityOfPage" : "https:\/\/magnuswahlstrand.github.io\/articles\/2022-07-09-trpc-with-lambda-function-urls-on-aws\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/magnuswahlstrand.github.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/magnuswahlstrand.github.io\/img\/avatar-icon.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Even simpler way of calling your AWS backend" />
<meta property="og:description" content="with tRPC and Lambda function URLS">
<meta property="og:image" content="https://magnuswahlstrand.github.io/img/avatar-icon.png" />
<meta property="og:url" content="https://magnuswahlstrand.github.io/articles/2022-07-09-trpc-with-lambda-function-urls-on-aws/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="wahlstrand.dev" />

  <meta name="twitter:title" content="Even simpler way of calling your AWS backend" />
  <meta name="twitter:description" content="with tRPC and Lambda function URLS">
  <meta name="twitter:image" content="https://magnuswahlstrand.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@wahlstra" />
  <meta name="twitter:creator" content="@wahlstra" />
  <link href='https://magnuswahlstrand.github.io/img/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.96.0" />
  <link rel="alternate" href="https://magnuswahlstrand.github.io/index.xml" type="application/rss+xml" title="wahlstrand.dev"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://magnuswahlstrand.github.io/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://magnuswahlstrand.github.io/css/highlight.min.css" /><link rel="stylesheet" href="https://magnuswahlstrand.github.io/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-190996420-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://magnuswahlstrand.github.io">wahlstrand.dev</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Fragments" href="/fragments">Fragments</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        
          
            <li>
              <a title="Now" href="/page/now">Now</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about">About</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="wahlstrand.dev" href="https://magnuswahlstrand.github.io">
            <img class="avatar-img" src="https://magnuswahlstrand.github.io/img/avatar-icon.png" alt="wahlstrand.dev" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Even simpler way of calling your AWS backend</h1>
              
              
              
                
                  <h2 class="post-subheading">with tRPC and Lambda function URLS</h2>

                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on July 9, 2022
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;11&nbsp;minutes
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;2271&nbsp;words
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Magnus Wahlstrand
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>A few weeks I wrote a post about using <a href="https://trpc.io/">tRPC</a> to get type safe requests between a web client and the
server. It turns out that there is an <em><strong>even simpler</strong></em> way of calling your AWS backend (still using tRPC) ü§Ø!</p>
<p>In this post I will show you how to use tRPC and a Lambda function
with <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-urls.html">Lambda Function URLs</a> to create a ToDo-app for my
terminal. The backend is deployed to AWS using the <a href="https://sst.dev/">Serverless Stack</a>.</p>

    <script src="https://magnuswahlstrand.github.io/js/asciinema-player.min.ad5df285ba10c3f22e8e6c659e7ba5b3.js"></script>
    <link rel="stylesheet" type="text/css" href="https://magnuswahlstrand.github.io/css/asciinema-player.min.769c38c8638dc8c9915bb6e6ef523e8b.css" />

<div id="demo1"></div>
<script>
AsciinemaPlayer.create("/casts/trpc-with-lambda-function-urls-on-aws/ts-prompt.cast", document.getElementById('demo1'), {
"autoplay": "true","cols": "80","loop": "true","poster": "npt:0:04","rows": "14",
});
</script>
<noscript><blockquote><p>To run this asciicast without javascript, use <code>asciinema play https://magnuswahlstrand.github.io/casts/trpc-with-lambda-function-urls-on-aws/ts-prompt.cast</code> with <a href="https://asciinema.org/">Asciinema</a></p></blockquote></noscript>

<p>This post is divided into two sections.</p>
<p><strong>Section 1 -</strong> First we set up our Lambda function with a public HTTPS endpoint and set up a type safe remote
procedure call using tRPC.</p>
<p><strong>Section 2 -</strong> Next, we turn the initial setup into a ToDo-app, by adding a database for persisting state, and
procedures to <em>create</em>, <em>list</em> and <em>complete</em> ToDos.</p>
<h2 id="overview">Overview</h2>
<p>Let us look at the system we will have built (after section 2).</p>
<p>The goal is to build a ToDo-app that we can run in our terminal. It will use a <strong>tRPC</strong> client to make requests to a <strong>Lambda function</strong> that stores our ToDos in a <strong>DynamoDB table</strong>. The Lambda function will be exposed as an HTTPS endpoint using a <strong>Lambda Function URL</strong>. As mentioned in the intro, this is deployed to AWS using the <a href="https://sst.dev/">Serverless Stack</a>.</p>
<p><img src="/img/trpc-with-lambda-function-urls-on-aws/overview.png" alt="Overview"></p>

<div style="color:gray; text-align: center; font-style: italic">
    <small>
        Our architecture diagram üôå
    </small>
</div>

<p>Before we get coding, let us go through what <strong>Lambda Function URLs</strong> and <strong>tRPC</strong>.</p>
<p>First, <a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-urls.html"><strong>Lambda Function URLs</strong></a> is a new feature (from April, 2022) for AWS Lambda that let us expose our Lambda function as HTTPS endpoints directly, without using an API gateway. This has been available for <a href="https://cloud.google.com/functions/docs/calling/http">GCP Functions</a> for a while, and it is great to see that Lambda get this feature as well. Here is a comparison of using an API Gateway in front of Lambda and using Function URLs directly:</p>
<table>
<thead>
<tr>
<th></th>
<th>API Gateway</th>
<th>Function URLs</th>
</tr>
</thead>
<tbody>
<tr>
<td>Authentication</td>
<td>IAM, Cognito, Lambda, API keys</td>
<td>IAM</td>
</tr>
<tr>
<td>Timeout</td>
<td>30 seconds</td>
<td>15 Minutes</td>
</tr>
<tr>
<td>Websocket</td>
<td>‚úîÔ∏è</td>
<td>‚ùå</td>
</tr>
<tr>
<td>Custom Domains</td>
<td>‚úîÔ∏è</td>
<td>‚ùå</td>
</tr>
<tr>
<td>CORS</td>
<td>‚úîÔ∏è</td>
<td>‚úîÔ∏è</td>
</tr>
<tr>
<td>Price</td>
<td>Medium</td>
<td>Low</td>
</tr>
<tr>
<td>URLs</td>
<td>One URL multiple endpoints</td>
<td>Multiple URLs</td>
</tr>
<tr>
<td>&hellip;</td>
<td>&hellip;</td>
<td>&hellip;</td>
</tr>
<tr>
<td>Cool üòé</td>
<td>‚ùì</td>
<td>‚úîÔ∏è</td>
</tr>
</tbody>
</table>

<div style="color:gray; text-align: center; font-style: italic">
    <small>
        <p>More details over
at <a href="https://www.serverlessguru.com/blog/aws-lambda-function-urls-vs-amazon-api-gateway">Serverless Guru</a></p>

    </small>
</div>

<p>For most production scenarios, you probably want an API Gateway. For my scenario, I use Function URLs here for a few reasons.</p>
<ol>
<li>Curiosity: Function URLs is a new feature for AWS, and I want to try them out!</li>
<li>Using tRPC, we only actually want and need a single endpoint. Perfect match!</li>
</ol>
<p>In short, I think Function URLs are a great match for my scenario!
<div style="height:1em;"></div>

The second concept is <strong>tRPC</strong>. It is a Typescript package that lets build fully type safe APIs for both with both server and client. As you will see, it <strong>REALLY</strong> simplifies making requests from a client to the server, while still being type safe. All this without requiring code generation. Read more about it in my post &ldquo;<a href="https://magnuswahlstrand.github.io/articles/2022-06-19-typesafe-http-client-serverless/">Typesafe serverless API with tRPC</a>&rdquo; (or in the <a href="https://trpc.io/docs">official documentation</a>).</p>
<p>Now we are ready to build a minimal client-server setup.</p>
<h1 id="section-1---the-basics">Section 1 - The basics</h1>
<p>First out, we create the boilerplate for our stack:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#998;font-style:italic"># First we initialize the Serverless Stack using the Typescript starter</span>
</span></span><span style="display:flex;"><span>npx create-sst@latest <span style="color:#d14">\
</span></span></span><span style="display:flex;"><span><span style="color:#d14"></span>  --template<span style="color:#000;font-weight:bold">=</span>starters/typescript-starter trpc-with-lambda-function-urls
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Install the dependencies</span>
</span></span><span style="display:flex;"><span><span style="color:#0086b3">cd</span> trpc-with-lambda-function-urls
</span></span><span style="display:flex;"><span>npm install 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"># Install the tRPC client and server packages</span>
</span></span><span style="display:flex;"><span>npm install @trpc/server @trpc/client
</span></span></code></pre></div><p>After the SST setup, our directory looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>‚îú‚îÄ‚îÄ package.json
</span></span><span style="display:flex;"><span>‚îú‚îÄ‚îÄ services
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îú‚îÄ‚îÄ functions
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ lambda.ts
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îú‚îÄ‚îÄ package.json
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îú‚îÄ‚îÄ test
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ sample.test.ts
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îî‚îÄ‚îÄ tsconfig.json
</span></span><span style="display:flex;"><span>‚îú‚îÄ‚îÄ sst.json
</span></span><span style="display:flex;"><span>‚îú‚îÄ‚îÄ stacks
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îú‚îÄ‚îÄ MyStack.ts
</span></span><span style="display:flex;"><span>‚îÇ¬†¬† ‚îî‚îÄ‚îÄ index.ts
</span></span><span style="display:flex;"><span>‚îú‚îÄ‚îÄ tsconfig.json
</span></span><span style="display:flex;"><span>‚îî‚îÄ‚îÄ vitest.config.ts
</span></span></code></pre></div><h2 id="updating-the-stack">Updating the stack</h2>
<p>As I mentioned in the introduction, we do not need the API gateway in our stack. Let&rsquo;s update the stack that SST gave us, and replace the API Gateway with it with a Lambda function. It is located in <code>./stacks/MyStack.ts</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-import { StackContext, Api } from &#34;@serverless-stack/resources&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+import { StackContext, Function } from &#34;@serverless-stack/resources&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>
</span></span><span style="display:flex;"><span> export function MyStack({ stack }: StackContext) {
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-  const api = new Api(stack, &#34;api&#34;, {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-    routes: {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-      &#34;GET /&#34;: &#34;functions/lambda.handler&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-    },
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-  });
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+  const fn = new Function(stack, &#34;trpc&#34;, {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+    handler: &#34;functions/lambda.handler&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+    url: true  // &lt;--- enable function URL
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+  })
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>   stack.addOutputs({
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-    ApiEndpoint: api.url
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+    FunctionURL: fn.url ?? &#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>   });
</span></span><span style="display:flex;"><span> }
</span></span></code></pre></div><p>Then we can deploy our stack for the first time. It takes around a minute.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>npm start
</span></span></code></pre></div><p>Output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>&gt; trpc-with-lambda-function-urls@0.0.0 start
</span></span><span style="display:flex;"><span>&gt; sst start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Look like you‚Äôre running sst <span style="color:#000;font-weight:bold">for</span> the first <span style="color:#0086b3">time</span> in this directory. Please enter a stage name you‚Äôd like to use locally. Or hit enter to use the one based on your AWS credentials <span style="color:#000;font-weight:bold">(</span>magnus<span style="color:#000;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>Using stage: magnus
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span> ‚úÖ  magnus-trpc-with-lambda-function-urls-MyStack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Stack magnus-trpc-with-lambda-function-urls-MyStack
</span></span><span style="display:flex;"><span>  Status: deployed
</span></span><span style="display:flex;"><span>  Outputs:
</span></span><span style="display:flex;"><span>    FunctionURL: https://kr2madrbusxrglf3aamfj7o4sy0hlebb.lambda-url.us-east-1.on.aws/
</span></span></code></pre></div><p>Open the <code>FunctionURL</code> from the ouput, and you should get a response from your function:</p>
<p><img src="/img/trpc-with-lambda-function-urls-on-aws/first_request.png" alt="First request"></p>
<p>How cool is that? Next we will replace it our tRPC handler Lambda.</p>
<h2 id="the-http-handler">The HTTP handler</h2>
<p>Replace the code in <code>./services/function/lambda.ts</code> with the following.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">as</span> trpc <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/server&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">as</span> z <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#34;zod&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {awsLambdaRequestHandler} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/server/adapters/aws-lambda&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> appRouter <span style="color:#000;font-weight:bold">=</span> trpc.router()
</span></span><span style="display:flex;"><span>    .query(<span style="color:#d14">&#39;sayHello&#39;</span>, {                    <span style="color:#998;font-style:italic">// 1. Procedure name
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        input: <span style="color:#458;font-weight:bold">z.string</span>(),                  <span style="color:#998;font-style:italic">// 2. Input 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">async</span> resolve(req) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">`Hello, </span><span style="color:#d14">${</span>req.input<span style="color:#d14">}</span><span style="color:#d14">!`</span>;  <span style="color:#998;font-style:italic">// 3. Response
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>        },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">type</span> AppRouter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">typeof</span> appRouter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">const</span> handler <span style="color:#000;font-weight:bold">=</span> awsLambdaRequestHandler({
</span></span><span style="display:flex;"><span>    router: <span style="color:#458;font-weight:bold">appRouter</span>,
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>SST will automatically reload the handler. If you go to the same URL as before, you will get an error similar to the one
below.</p>
<p><img src="/img/trpc-with-lambda-function-urls-on-aws/trpc_error.png" alt="tRPC error"></p>
<p><a href="https://knowyourmeme.com/memes/this-is-fine">This is fine</a>! The API is now a tRPC endpoint, and not ment to be called
directly by the browser.</p>
<p>Instead, let&rsquo;s create our terminal client.</p>
<h2 id="the-client">The client</h2>
<p>Create <code>./client/index.ts</code> and add:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">type</span> {AppRouter} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;../services/functions/lambda&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {createTRPCClient} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/client&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 1. Replace with your Function URL, e.g.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// https://kr2madrbusxrglf3aamfj7o4sy0hlebb.lambda-url.us-east-1.on.aws
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">const</span> function_url <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;&lt;YOUR FUNCTION URL HERE&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 2. Create tPRC client
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">const</span> client <span style="color:#000;font-weight:bold">=</span> createTRPCClient&lt;<span style="color:#000080">AppRouter</span>&gt;({
</span></span><span style="display:flex;"><span>    url: <span style="color:#458;font-weight:bold">function_url</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic">// 3. Make request to server
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>(<span style="color:#000;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> greeting <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">await</span> client.query(<span style="color:#d14">&#39;sayHello&#39;</span>, <span style="color:#d14">&#34;Bilbo&#34;</span>);
</span></span><span style="display:flex;"><span>    console.log(greeting)
</span></span><span style="display:flex;"><span>})()
</span></span></code></pre></div><p>We invoke our client with <code>npx ts-node ./client</code>. Output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Hello, Bilbo!
</span></span></code></pre></div><p>Success!</p>
<h3 id="summary---section-1">Summary - section 1</h3>
<p>What happened here?</p>
<ol>
<li>We created a client based on the <code>AppRouter</code> from the server</li>
<li>We made a request to remote procedure <code>sayHello</code> with the argument &ldquo;<code>Bilbo</code>&rdquo;.</li>
<li>Our handler (Lambda function) received the request, and understood how to route it to the right procedure <code>sayHello</code>
and responded with &ldquo;<code>Hello, Bilbo!</code>&rdquo;</li>
<li>Our client printed the greeting to the terminal</li>
</ol>

<div style="background-color: #F6F6F6; padding: 20px; border: 1px solid lightgray; margin-top: 20px">
    <b>Note: Type safety!</b>
    <p>What could be easy to miss here is that <strong>tRPC</strong> makes all this type safe. If I try to call a non-existent procedure, my editor
gives me a helpful warning:</p>
<p><img src="/img/trpc-with-lambda-function-urls-on-aws/error_1.png" alt="tRPC type error 1"></p>
<p>Same if the parameter is the wrong type:
<img src="/img/trpc-with-lambda-function-urls-on-aws/error_2.png" alt="tRPC type error 2"></p>
<p>Just as Typescripts makes our Javascript code more reliable using types and warnings in the editor, <strong>tRPC</strong> does the same
for making requests to our remote backend üíò.</p>

</div>

<p>This is all we need to set up a tRPC Lambda function on AWS and call it from a client! In the next section we will make our app a lot cooler. See you there!</p>
<h1 id="part-2---improving-the-app">Part 2 - Improving the app</h1>
<p>In this section we will say goodbye to our basic app <strong>Greeting Generating</strong> app into a cool <strong>ToDo</strong> app! For this we need the following changes</p>
<ol>
<li>Add a DynamoDB table to store our ToDos</li>
<li>Add one query and two mutations to our tRPC router</li>
<li>Change the client from a one of command to a terminal prompt</li>
</ol>
<h2 id="more-setup">More setup</h2>
<p>For the next steps, we need <code>ksuid</code> that will be used as ID for our ToDos, and <code>prompt</code> that is used by our client.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>npm install ksuid
</span></span><span style="display:flex;"><span>npm install prompts @types/prompts
</span></span></code></pre></div><h2 id="updating-the-stack-1">Updating the stack</h2>
<p>Next, we add a DynamoDB table, using the SST construct <a href="https://docs.sst.dev/constructs/Table"><strong>Table</strong></a>. Make sure to give the Lambda function permission to access the table, and set the name of the table as an environment.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#000;background-color:#fdd">-import {Function, StackContext} from &#34;@serverless-stack/resources&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#fdd"></span><span style="color:#000;background-color:#dfd">+import {Function, StackContext, Table} from &#34;@serverless-stack/resources&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> export function MyStack({stack}: StackContext) {
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+    const todoTable = new Table(stack, &#34;table&#34;, {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        fields: {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+            id: &#34;string&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        },
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        primaryIndex: {partitionKey: &#34;id&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+    })
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     const fn = new Function(stack, &#34;trpc&#34;, {
</span></span><span style="display:flex;"><span>         handler: &#34;functions/lambda.handler&#34;,
</span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        permissions: [todoTable],
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        environment: {
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+            TABLE_NAME: todoTable.tableName,
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd">+        },
</span></span></span><span style="display:flex;"><span><span style="color:#000;background-color:#dfd"></span>         url: true
</span></span><span style="display:flex;"><span>     })
</span></span></code></pre></div><h2 id="updating-the-router">Updating the router</h2>
<p>To make the code a bit easier to follow, I will break out the database calls to a separate file. We will create two mutations (writers of data) and one query (reader of data).</p>
<ul>
<li><code>createToDo(id: string, description: string)</code> (a mutation)</li>
<li><code>completeToDo(id: string)</code> (a mutation)</li>
<li><code>listToDos()</code> (a query)
Create a new file at <code>./services/functions/db.ts</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {DynamoDB} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#34;aws-sdk&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> tableName <span style="color:#000;font-weight:bold">=</span> process.env.TABLE_NAME <span style="color:#000;font-weight:bold">??</span> <span style="color:#d14">&#34;&#34;</span>   <span style="color:#998;font-style:italic">// &lt;--- 1. 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> dynamoDb <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> DynamoDB.DocumentClient();  <span style="color:#998;font-style:italic">// &lt;--- 2. 
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">type</span> ToDo <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>    id: <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    description: <span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    completed: <span style="color:#458;font-weight:bold">boolean</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">const</span> createToDo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">async</span> (id: <span style="color:#458;font-weight:bold">string</span>, description: <span style="color:#458;font-weight:bold">string</span>) <span style="color:#000;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> todo <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        id: <span style="color:#458;font-weight:bold">id</span>,
</span></span><span style="display:flex;"><span>        description: <span style="color:#458;font-weight:bold">description</span>,
</span></span><span style="display:flex;"><span>        completed: <span style="color:#458;font-weight:bold">false</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> putParams <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        TableName: <span style="color:#458;font-weight:bold">tableName</span>,
</span></span><span style="display:flex;"><span>        Item: <span style="color:#458;font-weight:bold">todo</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">await</span> dynamoDb.put(putParams).promise();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">const</span> completeToDo <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">async</span> (id: <span style="color:#458;font-weight:bold">string</span>) <span style="color:#000;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> updateParams <span style="color:#000;font-weight:bold">=</span> {
</span></span><span style="display:flex;"><span>        TableName: <span style="color:#458;font-weight:bold">tableName</span>,
</span></span><span style="display:flex;"><span>        Key<span style="color:#000;font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>            id: <span style="color:#458;font-weight:bold">id</span>,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        UpdateExpression<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">`set completed = :completed`</span>,
</span></span><span style="display:flex;"><span>        ExpressionAttributeValues<span style="color:#000;font-weight:bold">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;:completed&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d14">&#34;:id&#34;</span><span style="color:#000;font-weight:bold">:</span> id,
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        ConditionExpression<span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#34;id = :id&#34;</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">await</span> dynamoDb.update(updateParams).promise();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">const</span> listToDos <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">async</span> () <span style="color:#000;font-weight:bold">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> resp <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">await</span> dynamoDb.scan({
</span></span><span style="display:flex;"><span>        TableName: <span style="color:#458;font-weight:bold">tableName</span>
</span></span><span style="display:flex;"><span>    }).promise()
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">return</span> resp.Items<span style="color:#000;font-weight:bold">?</span>.map((item) <span style="color:#000;font-weight:bold">=&gt;</span> item <span style="color:#000;font-weight:bold">as</span> ToDo);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>I will not go into the details of how the request to DynamoDB works. A couple of notes:</p>
<ol>
<li>We get to use the environment variable <code>TABLE_NAME</code> we propagated in the stack.</li>
<li>The <strong>DynamoDB DocumentClient</strong> is A LOT easier to use the regular SDK client. I highly recommend it!</li>
</ol>
<p>For a better understanding of how to call DynamoDB with Javascript, I often refer to this <a href="https://dynobase.dev/dynamodb-nodejs">Cheat Sheet from Dynobase</a> (they also have it for <a href="https://dynobase.dev/dynamodb-golang-query-examples/">Go</a>, <a href="https://dynobase.dev/dynamodb-python-with-boto3/">Python</a>, probably everything else).</p>
<p>Now we can update our existing Lambda at <code>./services/functions/lambda.ts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">as</span> trpc <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/server&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">as</span> z <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#34;zod&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> KSUID <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;ksuid&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {awsLambdaRequestHandler} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/server/adapters/aws-lambda&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {completeToDo, createToDo, listToDos} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#34;./db&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> appRouter <span style="color:#000;font-weight:bold">=</span> trpc.router()
</span></span><span style="display:flex;"><span>    .mutation(<span style="color:#d14">&#39;createToDo&#39;</span>, {
</span></span><span style="display:flex;"><span>        input: <span style="color:#458;font-weight:bold">z.string</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">async</span> resolve(req) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">const</span> id <span style="color:#000;font-weight:bold">=</span> KSUID.randomSync().<span style="color:#458;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">await</span> createToDo(id, req.input)
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> id
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .mutation(<span style="color:#d14">&#39;completeToDo&#39;</span>, {
</span></span><span style="display:flex;"><span>        input: <span style="color:#458;font-weight:bold">z.string</span>(),
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">async</span> resolve(req) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> completeToDo(req.input)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>    .query(<span style="color:#d14">&#39;listToDos&#39;</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">async</span> resolve(_) {
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">return</span> listToDos()
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">type</span> AppRouter <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">typeof</span> appRouter;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">export</span> <span style="color:#000;font-weight:bold">const</span> handler <span style="color:#000;font-weight:bold">=</span> awsLambdaRequestHandler({
</span></span><span style="display:flex;"><span>    router: <span style="color:#458;font-weight:bold">appRouter</span>,
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><p>Here we have created 3 remote procedures:</p>
<ul>
<li><code>createToDo</code> - takes a description string as input, generates a KSUID, and creates a new Todo</li>
<li><code>completeToDo</code> - takes a KSUID string as input, marks that ToDo as completed</li>
<li><code>listToDos</code> - takes no input, returns all ToDos</li>
</ul>
<p>Once again, in order to test that our tRPC handler works, we need to use it in a client. Update the client as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">type</span> {AppRouter} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;../services/functions/lambda&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">import</span> {createTRPCClient} <span style="color:#000;font-weight:bold">from</span> <span style="color:#d14">&#39;@trpc/client&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> function_url <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;https://kr2madrbusxrglf3aamfj7o4sy0hlebb.lambda-url.us-east-1.on.aws&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">const</span> client <span style="color:#000;font-weight:bold">=</span> createTRPCClient&lt;<span style="color:#000080">AppRouter</span>&gt;({
</span></span><span style="display:flex;"><span>    url: <span style="color:#458;font-weight:bold">function_url</span>,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#000;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// Create two ToDos
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">const</span> first_id <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">await</span> client.mutation(<span style="color:#d14">&#39;createToDo&#39;</span>, <span style="color:#d14">&#34;Buy milk&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">const</span> secnd_id <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">await</span> client.mutation(<span style="color:#d14">&#39;createToDo&#39;</span>, <span style="color:#d14">&#34;Buy eggs&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// Mark one as completed
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">await</span> client.mutation(<span style="color:#d14">&#39;completeToDo&#39;</span>, first_id);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#998;font-style:italic">// List Todos
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">const</span> todos <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">await</span> client.query(<span style="color:#d14">&#39;listToDos&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">if</span>(<span style="color:#000;font-weight:bold">!</span>todos) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    todos.forEach(<span style="color:#000;font-weight:bold">function</span> (todo, i) {
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">const</span> state <span style="color:#000;font-weight:bold">=</span> todo.completed <span style="color:#000;font-weight:bold">?</span> <span style="color:#d14">&#34;completed&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#d14">&#34;in progress&#34;</span>
</span></span><span style="display:flex;"><span>        console.log(<span style="color:#d14">`</span><span style="color:#d14">${</span>i<span style="color:#000;font-weight:bold">+</span><span style="color:#099">1</span><span style="color:#d14">}</span><span style="color:#d14"> - </span><span style="color:#d14">${</span>todo.description<span style="color:#d14">}</span><span style="color:#d14"> (</span><span style="color:#d14">${</span>state<span style="color:#d14">}</span><span style="color:#d14">)`</span>, )
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>})()
</span></span></code></pre></div><p>If we run the client, we get the following output.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1 - Buy milk (completed)
</span></span><span style="display:flex;"><span>2 - Buy eggs (in progress)
</span></span></code></pre></div><p>Seems to work!</p>
<h2 id="client">Client</h2>
<p>Finally, let&rsquo;s turn our client into a prompt, as promised.</p>

<div style="background-color: #F6F6F6; padding: 20px; border: 1px solid lightgray; margin-top: 20px">
    <b>Note:</b>
    I have never developed command line clients in Typescript before. There are most likely better ways to write the following application ü§ì
</div>

<p>Replace the client code in <code>./client/index.ts</code> as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>import type {AppRouter} from &#39;../services/functions/lambda&#39;;
</span></span><span style="display:flex;"><span>import {createTRPCClient} from &#39;@trpc/client&#39;;
</span></span><span style="display:flex;"><span>import prompts from &#34;prompts&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const function_url = &#34;https://kr2madrbusxrglf3aamfj7o4sy0hlebb.lambda-url.us-east-1.on.aws&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const client = createTRPCClient&lt;AppRouter&gt;({
</span></span><span style="display:flex;"><span>    url: function_url,
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>const promptNewTodo = async () =&gt; {
</span></span><span style="display:flex;"><span>    const entered = await prompts({
</span></span><span style="display:flex;"><span>        type: &#39;text&#39;,
</span></span><span style="display:flex;"><span>        name: &#39;description&#39;,
</span></span><span style="display:flex;"><span>        message: `Please describe your ToDo`,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    await client.mutation(&#39;createToDo&#39;, entered.description)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>async function promptForTodoComplete() {
</span></span><span style="display:flex;"><span>    const todos = await client.query(&#39;listToDos&#39;) ?? [];
</span></span><span style="display:flex;"><span>    const todoChoices = todos.map((todo) =&gt; {
</span></span><span style="display:flex;"><span>        return {
</span></span><span style="display:flex;"><span>            title: todo.description + (todo.completed ? &#34; (completed)&#34; : &#34;&#34;),
</span></span><span style="display:flex;"><span>            description: `Mark as completed`,
</span></span><span style="display:flex;"><span>            value: todo.id,
</span></span><span style="display:flex;"><span>            disabled: todo.completed,
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    const choices = [
</span></span><span style="display:flex;"><span>        ...todoChoices,
</span></span><span style="display:flex;"><span>        {title: &#34;ACTION: CREATE TODO&#34;, value: &#34;new&#34;},
</span></span><span style="display:flex;"><span>        {title: &#34;ACTION: EXIT&#34;, value: &#34;exit&#34;}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    const selected = await prompts({
</span></span><span style="display:flex;"><span>        type: &#39;select&#39;,
</span></span><span style="display:flex;"><span>        name: &#34;id&#34;,
</span></span><span style="display:flex;"><span>        message: &#39;Select an action&#39;,
</span></span><span style="display:flex;"><span>        warn: &#34; &#34;,
</span></span><span style="display:flex;"><span>        hint: &#34; &#34;,
</span></span><span style="display:flex;"><span>        choices: choices,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    if (!selected.id || selected.id == &#34;exit&#34;) {
</span></span><span style="display:flex;"><span>        return {id: &#34;&#34;, exit: true}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    return {id: selected.id, exit: false}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(async () =&gt; {
</span></span><span style="display:flex;"><span>    console.log(&#34;Loading ToDos...&#34;)
</span></span><span style="display:flex;"><span>    let exit = false;
</span></span><span style="display:flex;"><span>    while (!exit) {
</span></span><span style="display:flex;"><span>        const {id, exit} = await promptForTodoComplete();
</span></span><span style="display:flex;"><span>        if (exit)
</span></span><span style="display:flex;"><span>            break
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        if (id == &#34;new&#34;) {
</span></span><span style="display:flex;"><span>            await promptNewTodo()
</span></span><span style="display:flex;"><span>        } else {
</span></span><span style="display:flex;"><span>            await client.mutation(&#39;completeToDo&#39;, id)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>})();
</span></span></code></pre></div><p>And for the last time, run the client. The app is now complete üëè!</p>


<div id="demo2"></div>
<script>
AsciinemaPlayer.create("/casts/trpc-with-lambda-function-urls-on-aws/ts-prompt.cast", document.getElementById('demo2'), {
"autoplay": "true","cols": "80","loop": "true","poster": "npt:0:04","rows": "14",
});
</script>
<noscript><blockquote><p>To run this asciicast without javascript, use <code>asciinema play https://magnuswahlstrand.github.io/casts/trpc-with-lambda-function-urls-on-aws/ts-prompt.cast</code> with <a href="https://asciinema.org/">Asciinema</a></p></blockquote></noscript>

<h1 id="conclusion">Conclusion</h1>
<p>We have created a semi-useful ToDo-app using <strong>tRPC</strong> and Lambda functions and Function URLs. I hope by now I have made it apparent how easy <strong>tRPC</strong> (and <strong>SST</strong>) made developing this app. I spent more time writing the silly prompt than hooking up the client to the server, and deploying it all. Great developer experience!</p>
<p>Hope you enjoyed this post.</p>
<p>Please send any feedback or comments to <a href="https://twitter.com/wahlstra">@wahlstra</a>.</p>
<h3 id="resources">Resources</h3>
<ul>
<li>I wrote more about tRPC here: <a href="https://magnuswahlstrand.github.io/articles/2022-06-19-typesafe-http-client-serverless/">Typesafe serverless API with tRPC</a></li>
<li>The <a href="https://trpc.io/">tRPC website</a></li>
<li><a href="https://www.serverlessguru.com/blog/aws-lambda-function-urls-vs-amazon-api-gateway">Comparison between API Gateway and Function URLs</a> by Serverless Guru</li>
<li><a href="https://dynobase.dev/dynamodb-nodejs">DynamoDB &amp; DocumentClient Cheat Sheet</a> from Dynobase</li>
</ul>

        
          <div class="blog-tags">
            
              <a href="https://magnuswahlstrand.github.io/tags/aws/">aws</a>&nbsp;
            
              <a href="https://magnuswahlstrand.github.io/tags/lambda/">lambda</a>&nbsp;
            
              <a href="https://magnuswahlstrand.github.io/tags/serverless/">serverless</a>&nbsp;
            
              <a href="https://magnuswahlstrand.github.io/tags/sst/">sst</a>&nbsp;
            
              <a href="https://magnuswahlstrand.github.io/tags/trpc/">trpc</a>&nbsp;
            
              <a href="https://magnuswahlstrand.github.io/tags/typescript/">typescript</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f&amp;text=Even%20simpler%20way%20of%20calling%20your%20AWS%20backend&amp;via=wahlstra" target="_blank" title="Share on Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f" target="_blank" title="Share on Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//reddit.com/submit?url=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f&amp;title=Even%20simpler%20way%20of%20calling%20your%20AWS%20backend" target="_blank" title="Share on Reddit">
          <i class="fab fa-reddit"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f&amp;title=Even%20simpler%20way%20of%20calling%20your%20AWS%20backend" target="_blank" title="Share on LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f&amp;title=Even%20simpler%20way%20of%20calling%20your%20AWS%20backend" target="_blank" title="Share on StumbleUpon">
          <i class="fab fa-stumbleupon"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fmagnuswahlstrand.github.io%2farticles%2f2022-07-09-trpc-with-lambda-function-urls-on-aws%2f&amp;description=Even%20simpler%20way%20of%20calling%20your%20AWS%20backend" target="_blank" title="Share on Pinterest">
          <i class="fab fa-pinterest"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">See also</h4>
                  <ul>
                
                
                    <li><a href="/articles/2022-06-26-event-based-system-on-aws/">Event-based apps with Go and EventBridge</a></li>
                
                    <li><a href="/articles/2022-06-19-typesafe-http-client-serverless/">Typesafe serverless API with tRPC</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://magnuswahlstrand.github.io/articles/2022-06-26-event-based-system-on-aws/" data-toggle="tooltip" data-placement="top" title="Event-based apps with Go and EventBridge">&larr; Previous Post</a>
            </li>
          
          
        </ul>
      


      
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="https://github.com/magnuswahlstrand" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/wahlstra" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Magnus Wahlstrand
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2022
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://magnuswahlstrand.github.io">wahlstrand.dev</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.96.0</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://magnuswahlstrand.github.io/js/main.js"></script>
<script src="https://magnuswahlstrand.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> $(document).ready(function() {$("pre.chroma").css("padding","0");}); </script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://magnuswahlstrand.github.io/js/load-photoswipe.js"></script>









    
  </body>
</html>

